name: Update Kindle Dashboard

on:
  schedule:
    - cron: '0 * * * *' # Updates every hour
  workflow_dispatch: 

permissions:
  contents: write # CRITICAL: Allows the action to push the image to your repo

jobs:
  build:
    runs-on: ubuntu-latest
    steps:
    - name: Checkout code
      uses: actions/checkout@v3

    # Injecting secrets into config.js
    - name: Inject Secrets into config.js
      run: |
        echo "var api_locParams = 'lat=${{ secrets.OWM_LAT }}&lon=${{ secrets.OWM_LON }}';" > config.js
        echo "var api_appId = '${{ secrets.OWM_APP_ID }}';" >> config.js
        echo "var api_lang = 'en';" >> config.js
        echo "var api_units = 'imperial';" >> config.js
        echo "var refreshTime = 30 * 60 * 1000;" >> config.js
        echo "var night_mode = 'off';" >> config.js
        echo "var utcOffset = null;" >> config.js

    - name: Take Screenshot
      uses: karol-brejna-i/webpage-screenshot-action@v1
      with:
        url: file://${{ github.workspace }}/index_old.html
        width: 1072
        height: 1448
        output: dashboard.png
        delay: 10  # <--- ADD THIS LINE (waits 10 seconds for data to load)

    - name: Commit and Push
      run: |
        git config --global user.name 'github-actions[bot]'
        git config --global user.email 'github-actions[bot]@users.noreply.github.com'
        git add dashboard.png
        git commit -m "Update dashboard image [skip ci]" || exit 0
        git push
